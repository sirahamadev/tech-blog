# バッチ実行基盤の全体像

## このメモの目的

- 「ジョブネット」「OPM」「スケジュールファイル」の会話が**翻訳できる状態**になる
- Terasoluna Batch を前提に、**バッチがどう成り立ち、誰が何を担当するか**を整理する

## 1. バッチとは何か（本質）

**バッチ = OS上で起動される Java プロセス**

- 正体は `java -jar batch.jar ...`
- スケジューラやOPMは「起動役」にすぎない
- 成功／失敗は **exit code（0 / 0以外）** で判断される

## 2. Terasoluna Batch の構成要素

### (1) 実行モジュール

- `batch.jar`（Spring Batchベース）
- 依存ライブラリ（fat jar or lib/）

### (2) 設定ファイル

- `application.yml / properties`
- DB接続情報、ログ設定、プロファイル（dev/stg/prod）

### (3) DB（2種類）

- **業務DB**：実データ
- **Batch管理DB**：実行履歴・状態管理
  - `BATCH_JOB_INSTANCE`
  - `BATCH_JOB_EXECUTION`
  - `BATCH_STEP_EXECUTION`

### (4) 実行スクリプト

- `run-job.sh`
- OPM / スケジューラは最終的にこれを叩く

### (5) ログ

- stdout / stderr
- ローテーション・監視対象

## 3. Spring Batch（Terasoluna Batch）の内部構造

- **Job**：処理単位（例：売上集計）
- **Step**：Job内の工程
- **Reader / Processor / Writer**：1件ずつ処理する部品

> 基本思想：**1回の起動で1 Job**

## 4. ジョブネットとは何か

**ジョブネット = 複数バッチの依存関係つき実行フロー**

例：

- A（取込）→ B（集計）→ C（帳票）

### 実現方法

1. **外側で制御**（主流）
   - OPM / スケジューラで順序制御

2. **内側で制御**
   - 1 Job の中に Step を並べる

## 5. OPMとは何か

**OPM = 運用管理ツール（Operation Management）**

### OPMの役割

- 実行スケジュール管理
- ジョブネット（依存関係）制御
- 実行状況の可視化
- 障害時の再実行・手動実行

### 重要な前提

- OPMは **Java / Spring を知らない**
- コマンドを実行して **exit code だけを見る**

代表例：JP1 / Hinemos / Systemwalker / Control-M など

## 6. スケジュールファイル vs OPM

| 観点           | スケジュールファイル | OPM |
| -------------- | -------------------- | --- |
| 管理方法       | ファイル（Git）      | GUI |
| バージョン管理 | ◎                    | △   |
| 自動化         | ◎                    | △   |
| 障害対応       | △                    | ◎   |

**議論の本質**：

> 起動と依存関係を「コードで持つか」「運用ツールで持つか」

## 7. 実行の全体像（図解イメージ）

```
[OPM / Scheduler]
        ↓
   run-job.sh
        ↓
 java -jar batch.jar
        ↓
  Spring Batch Job
        ↓
  業務DB / 管理DB
```

## 8. 基盤チームの責務（重要）

- OPMから**安全に起動できる**こと
- 再実行できる（冪等性）
- exit code が正しい
- ログが追える
- 環境差分を吸収できる

> OPMに優しいバッチ実行基盤を作る

## 9. 会話の翻訳辞書

| 聞こえる言葉 | 翻訳                   |
| ------------ | ---------------------- |
| バッチ       | Javaプロセス           |
| ジョブ       | 1処理単位              |
| ジョブネット | バッチの流れ           |
| OPM          | 運用起動・監視ツール   |
| 再実行       | 同じコマンドをもう一度 |

## 10. 最低限言えたらOKな一文

> 「Terasoluna BatchはJavaプロセスで、OPMはそれを起動・監視・再実行する運用ツール。ジョブネットはその外側で依存関係を制御している。」

（この先の発展）

- 良いバッチ設計（冪等性・再実行設計）
- exit code 設計
- OPM前提の設計アンチパターン
