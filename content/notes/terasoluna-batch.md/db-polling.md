<!-- copied from: second-brain/TERASOLUNA-Batch/DBポーリング.md -->
<!-- original-filename: DBポーリング.md -->

# DBポーリングとは（TERASOLUNA Batch）

## 概要（結論）

**DBポーリングとは、DBをキュー代わりにして非同期にジョブを実行する仕組みである。**

- Web画面や他システムからの「処理依頼」を **DBに蓄積**
- バッチが **定期的にDBを監視（Polling）**
- 未処理の依頼を検知してジョブを起動する

TERASOLUNA Batch では、  
**「Web から直接 Job を起動しない」ための公式な非同期実行方式**として位置づけられている。

---

## なぜ DBポーリングが必要なのか

通常の Spring Batch / TERASOLUNA Batch は、以下のような即時実行モデルである。

```text
コマンド実行
  ↓
Job 起動
  ↓
即実行
```

しかし、業務要件では次のような要望が多い。

- Web画面から処理を依頼したい
- 重い処理なので即時実行は避けたい
- 依頼順に非同期で処理したい
- 再起動しても処理依頼を失いたくない

これらを満たすために、
**「処理依頼をDBに書き、後からバッチが拾う」**という方式が採用される。

---

## DBポーリングの全体構成

### 登場人物

| 役割                       | 説明                       |
| -------------------------- | -------------------------- |
| 業務側（Web / 他システム） | 処理依頼をDBに登録         |
| ポーリングバッチ           | 定期的にDBを監視           |
| 実処理ジョブ               | 依頼内容に応じた処理を実行 |

### 全体イメージ

```text
業務画面
  ↓
DB（ジョブ要求テーブル）
  ↓
ポーリングバッチ
  ↓
実処理ジョブ
```

---

## ジョブ要求テーブルの役割

DBには **ジョブ要求テーブル** を用意する。

例：

```text
JOB_REQUEST
--------------------------------
| request_id | job_name | status |
--------------------------------
| 1          | jobA     | READY  |
| 2          | jobB     | READY  |
```

ステータスの意味：

- `READY` : 未処理
- `RUNNING` : 実行中
- `COMPLETED` : 正常終了
- `FAILED` : 異常終了

---

## ポーリングバッチの処理フロー

1. **定期起動**
   cron などで一定間隔ごとに起動

2. **未処理データの検索**

   ```sql
   SELECT * FROM JOB_REQUEST WHERE status = 'READY';
   ```

3. **対象レコードのロック**
   - `SELECT FOR UPDATE`
   - またはステータス更新による排他制御

4. **ジョブ起動**

   ```java
   jobLauncher.run(job, jobParameters);
   ```

5. **結果に応じてステータス更新**

   ```text
   RUNNING → COMPLETED / FAILED
   ```

---

## 「DBポーリング」という名前の意味

用語としては難しく見えるが、やっていることは単純。

- **Polling** : 定期的に確認する
- **DB Polling** : DBを定期的に確認する

概念的には以下と同じ。

```text
while (true) {
  DBを確認
  依頼があれば処理
  少し待つ
}
```

これを **業務向けに安全・堅牢に設計したもの**が、
TERASOLUNA Batch の DBポーリング方式である。

---

## なぜ MQ（RabbitMQ 等）を使わないのか

比較すると以下の通り。

| 観点           | DBポーリング     | MQ                     |
| -------------- | ---------------- | ---------------------- |
| 導入コスト     | 低い（DBのみ）   | 高い（別ミドルウェア） |
| 運用負荷       | 低い             | 高い                   |
| 処理速度       | 普通             | 高速                   |
| 向いている用途 | 基幹・業務バッチ | リアルタイム処理       |

TERASOLUNA Batch は **基幹系・業務系バッチ向けフレームワーク**であるため、
DBポーリング方式が採用されている。

---

## ガイドラインの本質（重要）

ガイドラインが伝えたいポイントは次の通り。

- Web から直接 Job を起動しない
- 処理依頼は必ず DB に書く
- バッチは DB を監視して自律的に動作する

つまり、推奨構造は以下。

```text
画面 → DB → バッチ → ジョブ
```

---

## ブランクプロジェクトとの関係

現在の作業内容：

- ブランクプロジェクト作成
- Chunk / Tasklet サンプル作成
- 業務チームへの引き渡し

この段階では、

- DBポーリングは **実装必須ではない**
- **概念理解レベルで十分**

業務チーム向けの説明としては、以下が書ければ十分である。

> 非同期実行が必要な場合は DBポーリング方式を採用する。
> Web 画面からの Job 直接起動は禁止する。

この一文があるだけで、設計レビューは通る。

---

## まとめ

- DBポーリングは「DBをキューとして使う非同期実行方式」
- Web 直起動を避け、業務バッチを安全に運用するための仕組み
- TERASOLUNA Batch の思想に強く沿った設計
- 初期サンプルでは理解のみでOK
